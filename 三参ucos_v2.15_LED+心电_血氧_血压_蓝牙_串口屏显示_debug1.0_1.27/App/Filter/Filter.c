/*********************************************************************************************************
* 模块名称：LED.c
* 摘    要：LED模块
* 当前版本：1.0.0
* 作    者：Leyutek(COPYRIGHT 2018 - 2021 Leyutek. All rights reserved.)
* 完成日期：2021年07月01日
* 内    容：
* 注    意：
**********************************************************************************************************
* 取代版本：
* 作    者：
* 完成日期：
* 修改内容：
* 修改文件：
*********************************************************************************************************/

/*********************************************************************************************************
*                                              包含头文件
*********************************************************************************************************/
#include "Filter.h"
#include "stdlib.h"
#include "gd32f30x_conf.h"

/*********************************************************************************************************
*                                              宏定义
*********************************************************************************************************/
/*********************************************************************************************************
*                                              枚举结构体
*********************************************************************************************************/

/*********************************************************************************************************
*                                              内部变量
*********************************************************************************************************/
//irr切比雪夫2型80hz低通滤波器
const int irr_tcheb_80hz_lp_NL = 9;
const float irr_tcheb_80hz_lp_num[9] = {0.03698417172,  0.05193228275,   0.1163011119,   0.1402810663,   0.1638770252,0.1402810663,   0.1163011119,  0.05193228275,  0.03698417172};
const float irr_tcheb_80hz_lp_den[9] = {1,   -1.715506077,    2.465377092,   -1.779324412,    1.137037277,-0.368838191,   0.1235706806,-0.009938980453, 0.002496804576};

//iir50hz陷波器
const int irr_50hz_notch_NL = 3;
const float irr_50hz_notch_num[3] = { 0.9936459064,   -1.607752919,   0.9936459064};
const float irr_50hz_notch_den[3] = {1,   -1.607752919,   0.9872918725};

//f125_15-20hzlp
const int f125_15_20LP_NL = 8;
const float f125_15_20LP_num[8] = { 0.00002552373917,0.0001786661742,0.0005359985516,   0.0008933309,   0.0008933309,
  0.0005359985516,0.0001786661742,0.00002552373917};
const float f125_15_20LP_den[8] = {1,   -5.387711525,    13.23163795,   -19.06243896,     17.3331852,
     -9.929253578,    3.316933393,  -0.4990849495};


/*********************************************************************************************************
*                                              内部函数声明
*********************************************************************************************************/
/*********************************************************************************************************
*                                              内部函数实现
*********************************************************************************************************/
/*********************************************************************************************************
*                                              API函数实现
*********************************************************************************************************/
/*********************************************************************************************************
* 函数名称：CreatIRR_Filter_str
* 函数功能：创建滤波器结构体
* 输入参数：deg--滤波器阶数+1,即x,y的点数；s_num--系统函数分子；s_den--系统函数分母；ptr--陷波器结构体指针
* 输出参数：void
* 返 回 值：float--滤波后数据
* 创建日期：2021年07月01日
* 注    意：
*********************************************************************************************************/
void CreatIRR_Filter_str(int deg, const float* s_num, const float* s_den, IRR_Filter_str* ptr)
{
  ptr->degree = deg;
  ptr->den = s_den;
  ptr->num = s_num;
  ptr->x = (float*)malloc(deg*sizeof(float));
  ptr->y = (float*)malloc(deg*sizeof(float));
}
/*********************************************************************************************************
* 函数名称：FreeIRR_Filter_str
* 函数功能：删除滤波器结构体
* 输入参数：void
* 输出参数：void
* 返 回 值：float--滤波后数据
* 创建日期：2021年07月01日
* 注    意：
*********************************************************************************************************/
void FreeIRR_Filter_str(IRR_Filter_str* ptr)
{
  free(ptr->x);
  free(ptr->y);
}
/*********************************************************************************************************
* 函数名称：InitIRR_Filter_str
* 函数功能：初始化IIR滤波器
* 输入参数：ptr--滤波器结构体指针
* 输出参数：void
* 返 回 值：void
* 创建日期：2021年07月01日
* 注    意：
*********************************************************************************************************/
void InitIRR_Filter_str(IRR_Filter_str* ptr)
{
  int i;
  for(i = 0;i<ptr->degree;i++)
  {
    ptr->x[i] = 0;
    ptr->y[i] = 0;
  }
}
/*********************************************************************************************************
* 函数名称：IIR
* 函数功能：IIR滤波
* 输入参数：ptr--陷波器结构体指针,x--数据
* 输出参数：void
* 返 回 值：float--滤波后数据
* 创建日期：2021年07月01日
* 注    意：
*********************************************************************************************************/
float IIR_Filter(float x,IRR_Filter_str* ptr)
{
  int i;
  for(i = ptr->degree - 1;i>=0;i--)
  {
    ptr->x[i] = ptr->x[i-1];
    ptr->y[i] = ptr->y[i-1];
  }
  ptr->x[0] = x;
  ptr->y[0] = 0;
  for(i = 0;i<ptr->degree;i++)
  {
    ptr->y[0] -= ptr->y[i]*ptr->den[i];
    ptr->y[0] += ptr->x[i]*ptr->num[i];
  }
  
  return *(ptr->y);
}
